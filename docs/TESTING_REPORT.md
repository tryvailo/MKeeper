# –û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: Memory Keeper
## –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–∞

**–î–∞—Ç–∞:** 22 –Ω–æ—è–±—Ä—è 2025  
**–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫:** AI Code Reviewer  
**–û–±–ª–∞—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** –°–æ–∑–¥–∞–Ω–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏, fallback –º–µ—Ç–æ–¥—ã, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

## üìã EXECUTIVE SUMMARY

### –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ **–Æ–Ω–∏—Ç —Ç–µ—Å—Ç—ã:** –ß–∞—Å—Ç–∏—á–Ω–æ –ø–æ–∫—Ä—ã—Ç—ã (validation, error-handler)
- ‚ö†Ô∏è **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:** –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
- ‚ö†Ô∏è **E2E —Ç–µ—Å—Ç—ã:** –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
- ‚úÖ **Fallback –º–µ—Ç–æ–¥—ã:** –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç, –Ω–æ —Ç—Ä–µ–±—É—é—Ç —É–ª—É—á—à–µ–Ω–∏—è
- ‚ö†Ô∏è **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –ë–∞–∑–æ–≤–∞—è, –Ω–æ –Ω–µ–ø–æ–ª–Ω–∞—è

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
1. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π (saveUserPreferences, createFamilyMember)
2. ‚ö†Ô∏è –ù–µ–ø–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö
3. ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
4. ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ race conditions –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è—Ö

---

## 1. –ê–ù–ê–õ–ò–ó –Æ–ù–ò–¢ –¢–ï–°–¢–û–í

### 1.1 –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã

#### ‚úÖ `__tests__/lib/validation.test.ts`
**–ü–æ–∫—Ä—ã—Ç–∏–µ:** –•–æ—Ä–æ—à–µ–µ –¥–ª—è validation —Ñ—É–Ω–∫—Ü–∏–π

**–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:**
- ‚úÖ `preferencesSchema` - –≤–∞–ª–∏–¥–∞—Ü–∏—è preferences
- ‚úÖ `familyMemberSchema` - –≤–∞–ª–∏–¥–∞—Ü–∏—è family members
- ‚úÖ `shareableLinkSchema` - –≤–∞–ª–∏–¥–∞—Ü–∏—è shareable links
- ‚úÖ `activityLogSchema` - –≤–∞–ª–∏–¥–∞—Ü–∏—è activity logs
- ‚úÖ `commentSchema` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- ‚úÖ `validateData` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è edge cases (null, undefined, –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏)
- ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è boundary values (min/max –¥–ª–∏–Ω—ã)
- ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è interview fields (32 –ø–æ–ª—è)

#### ‚úÖ `__tests__/lib/supabase-error-handler.test.ts`
**–ü–æ–∫—Ä—ã—Ç–∏–µ:** –•–æ—Ä–æ—à–µ–µ –¥–ª—è error handling

**–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:**
- ‚úÖ `formatSupabaseError` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- ‚úÖ `isConnectionError` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ connection errors
- ‚úÖ `getUserFriendlyError` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ `isSupabaseConfigured` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ Supabase
- ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫

### 1.2 –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã

#### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ —Ç–µ—Å—Ç–æ–≤:

1. **`lib/api.ts` - saveUserPreferences**
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Å–ª–∏—è–Ω–∏—è interview_data
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (23505)
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è retry –ª–æ–≥–∏–∫–∏
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

2. **`lib/api.ts` - getUserPreferences**
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ PGRST116
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è null –≤–æ–∑–≤—Ä–∞—Ç–∞

3. **`lib/api.ts` - createFamilyMember**
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ownership
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ email
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

4. **`lib/api.ts` - updateFamilyMember / deleteFamilyMember**
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ownership
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —á–ª–µ–Ω–æ–≤
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è unauthorized access

5. **`lib/memory-data.ts` - getInterviewDataFromPreferences**
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è backward compatibility
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ interview_data vs –ø—Ä—è–º—ã—Ö –ø–æ–ª–µ–π

6. **`lib/interview.ts` - —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è validateAnswer
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è calculateWordCount
   - ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è getCategoryByStep

---

## 2. –ê–ù–ê–õ–ò–ó FALLBACK –ú–ï–¢–û–î–û–í

### 2.1 –ù–∞–π–¥–µ–Ω–Ω—ã–µ fallback –º–µ—Ç–æ–¥—ã

#### ‚úÖ `app/api/family/[token]/route.ts` - Legacy Support
```typescript
// Fallback: try shared_access table (legacy support)
const { data: sharedAccess, error: sharedError } = await supabase
  .from("shared_access")
  .select("preference_id")
  .eq("access_token", token)
  .single();
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –•–æ—Ä–æ—à–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è fallback –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚ö†Ô∏è –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è legacy usage

#### ‚úÖ `lib/api.ts` - saveUserPreferences - Retry Logic
```typescript
// If insert fails with conflict (409), try update instead
if (error && (error.code === '23505' || ...)) {
  console.log("Insert conflict detected, trying update instead...");
  // Retry with update
}
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –•–æ—Ä–æ—à–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω retry - –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
- ‚ö†Ô∏è –ù–µ—Ç exponential backoff
- ‚ö†Ô∏è –ù–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫

#### ‚úÖ `app/api/family/invite/route.ts` - Email Fallback
```typescript
// Send email invitation
let emailSent = false;
try {
  const emailResult = await sendShareInviteEmail(...);
  emailSent = emailResult.success || false;
} catch (emailError) {
  console.error("Error sending email:", emailError);
}
// Continue even if email fails
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –•–æ—Ä–æ—à–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
- ‚ö†Ô∏è –ù–µ—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è email

#### ‚úÖ `app/api/family/invite/route.ts` - Legacy shared_access
```typescript
// Create shared access record (legacy support)
try {
  await supabase.from("shared_access").insert({...});
} catch (error) {
  console.warn("Failed to create shared_access record:", error);
  // Continue - this is for legacy support
}
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –•–æ—Ä–æ—à–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ legacy –æ–ø–µ—Ä–∞—Ü–∏–π

### 2.2 –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ fallback –º–µ—Ç–æ–¥—ã

#### ‚ùå `lib/api.ts` - getUserPreferences
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç fallback –¥–ª—è connection errors
```typescript
// –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
if (error) {
  if (error.code === "PGRST116" || error.message?.includes("No rows")) {
    return null;
  }
  console.error("Error fetching preferences:", error);
  return null; // ‚ùå –ù–µ—Ç retry –¥–ª—è connection errors
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
if (error) {
  if (error.code === "PGRST116" || error.message?.includes("No rows")) {
    return null;
  }
  // Retry for connection errors
  if (isConnectionError(error)) {
    // Retry logic here
  }
  console.error("Error fetching preferences:", error);
  return null;
}
```

#### ‚ùå `lib/api.ts` - createFamilyMember
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç fallback –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ email
```typescript
// –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
if (error) {
  console.error("Error creating family member:", error);
  return null; // ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
if (error) {
  if (error.code === '23505') {
    // Duplicate email - return existing member or update
    const existing = await getFamilyMemberByEmail(email);
    return existing;
  }
  console.error("Error creating family member:", error);
  return null;
}
```

#### ‚ùå `app/onboarding/page.tsx` - Auto-save
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç fallback –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º auto-save
```typescript
// –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
if (!response.ok) {
  console.warn("Auto-save failed (non-critical):", response.status);
  // ‚ùå –ù–µ—Ç retry –∏–ª–∏ queue –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å retry queue –¥–ª—è failed auto-saves
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ localStorage –∫–∞–∫ fallback
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## 3. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –¶–ï–ü–û–ß–ö–ò –°–û–ó–î–ê–ù–ò–Ø –í–û–°–ü–û–ú–ò–ù–ê–ù–ò–ô

### 3.1 Happy Path (–£—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π)

#### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π
**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `/onboarding`
2. –ó–∞–ø–æ–ª–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5)
3. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
4. Auto-save —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
5. –ó–∞–≤–µ—Ä—à–∞–µ—Ç onboarding
6. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –í—Å–µ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `interview_data`
- ‚úÖ –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ `/dashboard/memories`
- ‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ `/onboarding`

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è Race condition: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É —à–∞–≥–∞–º–∏, auto-save –º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å
- ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø–µ—Ä–µ–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º

#### –¢–µ—Å—Ç 2: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π
**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `/dashboard/memories`
2. –í–∏–¥–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Ç–≤–µ—Ç—ã
3. –ò–∑–º–µ–Ω—è–µ—Ç –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç
4. –ù–∞–∂–∏–º–∞–µ—Ç "Save Changes"
5. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- ‚úÖ –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è
- ‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- ‚ö†Ô∏è –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

### 3.2 Edge Cases (–ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏)

#### –¢–µ—Å—Ç 3: –ü—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// lib/api.ts:134
if (Object.keys(interviewData).length === 0 && Object.keys(regularPreferences).length === 0) {
  console.warn("No data to save - all fields are empty");
  // Still allow saving empty record
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –°–æ–∑–¥–∞–µ—Ç—Å—è –ø—É—Å—Ç–∞—è –∑–∞–ø–∏—Å—å –≤ –ë–î
- ‚ö†Ô∏è –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤—Å–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ

#### –¢–µ—Å—Ç 4: –ß–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –ø–æ–ª–µ –∏–∑ 32

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// lib/api.ts:152-159
if (existing?.interview_data) {
  preferencesWithUserId.interview_data = {
    ...(existing.interview_data as Record<string, string>),
    ...interviewData,
  };
}
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç —Ç–µ—Å—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
- ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –≤—Å–µ 32 –ø–æ–ª—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

#### –¢–µ—Å—Ç 5: –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –æ—Ç–≤–µ—Ç > 5000 —Å–∏–º–≤–æ–ª–æ–≤

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// lib/validation.ts:18
happiest_memory: z.string().max(5000).optional(),
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- ‚ö†Ô∏è –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∑–Ω–∞–µ—Ç –æ–± –æ—à–∏–±–∫–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ —Å –ø–æ–∫–∞–∑–æ–º —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ –ª–∏–º–∏—Ç—É

#### –¢–µ—Å—Ç 6: –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –î–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- ‚ùå –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç (last write wins)
- ‚ùå –ú–æ–≥—É—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è –¥–∞–Ω–Ω—ã–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å optimistic locking (version field)
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
- –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å merge –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 3.3 Error Cases (–û—à–∏–±–∫–∏)

#### –¢–µ—Å—Ç 7: –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// app/onboarding/page.tsx:218
catch (error) {
  console.error("Error saving preferences:", error);
  alert(errorMessage);
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞
- ‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ localStorage –∫–∞–∫ fallback
- Retry –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è..."

#### –¢–µ—Å—Ç 8: –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// lib/api.ts:227-249
if (error) {
  console.error("Error saving preferences:", error);
  // Retry logic exists but limited
}
```

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è Retry —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (23505)
- ‚ö†Ô∏è –ù–µ—Ç retry –¥–ª—è connection errors
- ‚ö†Ô∏è –ù–µ—Ç exponential backoff

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å retry –¥–ª—è –≤—Å–µ—Ö connection errors
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å exponential backoff
- –î–æ–±–∞–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫

#### –¢–µ—Å—Ç 9: –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// app/onboarding/page.tsx:39
if (!user) {
  router.push("/sign-in");
  return;
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ
- ‚ö†Ô∏è –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ localStorage –ø–µ—Ä–µ–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º
- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö

---

## 4. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –¶–ï–ü–û–ß–ö–ò –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ß–õ–ï–ù–û–í –°–ï–ú–¨–ò

### 4.1 Happy Path

#### –¢–µ—Å—Ç 10: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏
**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `/dashboard/family`
2. –ù–∞–∂–∏–º–∞–µ—Ç "Add Family Member"
3. –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É (email, name, relationship, accessLevel)
4. –ù–∞–∂–∏–º–∞–µ—Ç "Send Invitation"
5. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ø–∏—Å–æ–∫ —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ß–ª–µ–Ω —Å–µ–º—å–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ë–î
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π sharing_token
- ‚úÖ Email –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è (–∏–ª–∏ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)
- ‚úÖ –ß–ª–µ–Ω —Å–µ–º—å–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ shared_access (legacy)

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ email
- ‚ö†Ô∏è –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- ‚ö†Ô∏è –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω

#### –¢–µ—Å—Ç 11: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏
**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏
2. –ù–∞–∂–∏–º–∞–µ—Ç "Edit" –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —á–ª–µ–Ω–µ
3. –ò–∑–º–µ–Ω—è–µ—Ç access_level
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –î–æ—Å—Ç—É–ø –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ UI
- ‚úÖ Activity log —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–µ—Ç preferences
- ‚ö†Ô∏è –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

#### –¢–µ—Å—Ç 12: –£–¥–∞–ª–µ–Ω–∏–µ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏
**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏
2. –ù–∞–∂–∏–º–∞–µ—Ç "Delete" –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —á–ª–µ–Ω–µ
3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ
4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ø–∏—Å–æ–∫

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ß–ª–µ–Ω —Å–µ–º—å–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –ë–î
- ‚úÖ –£–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ shared_access (legacy)
- ‚úÖ –ò—Å—á–µ–∑–∞–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
- ‚úÖ Activity log —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–µ—Ç preferences
- ‚ö†Ô∏è –ù–µ—Ç –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- ‚ö†Ô∏è –ù–µ—Ç soft delete (–¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞)

### 4.2 Edge Cases

#### –¢–µ—Å—Ç 13: –î—É–±–ª–∏–∫–∞—Ç email
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞ —Å–µ–º—å–∏ —Å email, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// lib/api.ts:400
if (error) {
  console.error("Error creating family member:", error);
  return null; // ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
- ‚ùå –ù–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
if (error?.code === '23505') {
  // Check if it's a duplicate email
  const existing = await getFamilyMemberByEmail(email);
  if (existing) {
    return { error: "This email is already invited" };
  }
}
```

#### –¢–µ—Å—Ç 14: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π email
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π email

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// app/api/family/invite/route.ts:47
const validation = validateData(familyMemberSchema, memberData);
if (!validation.success) {
  return NextResponse.json(
    { error: "Validation failed", errors: validation.errors },
    { status: 400 }
  );
}
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –µ—Å—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∑–Ω–∞–µ—Ç –æ–± –æ—à–∏–±–∫–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é email –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

#### –¢–µ—Å—Ç 15: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ preferences
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞ —Å–µ–º—å–∏, –Ω–æ —É –Ω–µ–≥–æ –Ω–µ—Ç preferences

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// lib/api.ts:377
const preferences = await getUserPreferences(userId);
if (!preferences || preferences.id !== preferencesId) {
  console.error("User does not own these preferences");
  return null;
}
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å
**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚ö†Ô∏è –ù–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ preferences

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Å–æ–∑–¥–∞—Ç—å preferences —Å–Ω–∞—á–∞–ª–∞

#### –¢–µ—Å—Ç 16: Email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
**–°—Ü–µ–Ω–∞—Ä–∏–π:** Email —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ —á–ª–µ–Ω —Å–µ–º—å–∏ —Å–æ–∑–¥–∞–Ω

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// app/api/family/invite/route.ts:101-118
let emailSent = false;
try {
  const emailResult = await sendShareInviteEmail(...);
  emailSent = emailResult.success || false;
} catch (emailError) {
  console.error("Error sending email:", emailError);
}
// Continue even if email fails
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Fallback –µ—Å—Ç—å
**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
- ‚ö†Ô∏è –ù–µ—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞
- ‚ö†Ô∏è –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å email –ø–æ–∑–∂–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
- –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "Resend Email"
- –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º

### 4.3 Error Cases

#### –¢–µ—Å—Ç 17: –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞ —Å–µ–º—å–∏ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// app/api/family/invite/route.ts:18
const userId = await getCurrentUserId();
if (!userId) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
}
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å
**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫—É

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

#### –¢–µ—Å—Ç 18: –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π email

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —ç—Ç–æ
- ‚ùå –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç –∏–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
const currentUser = await getCurrentUser();
if (email === currentUser?.email) {
  return NextResponse.json(
    { error: "You cannot invite yourself" },
    { status: 400 }
  );
}
```

#### –¢–µ—Å—Ç 19: –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ë–î
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// lib/api.ts:400
if (error) {
  console.error("Error creating family member:", error);
  return null; // ‚ùå –ù–µ—Ç retry
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫—É
- ‚ùå –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã —Ç–µ—Ä—è—é—Ç—Å—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å retry —Å exponential backoff
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –≤ localStorage
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞..."

---

## 5. –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 5.1 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 1: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
**–§—É–Ω–∫—Ü–∏–∏ –±–µ–∑ —Ç–µ—Å—Ç–æ–≤:**
- `saveUserPreferences` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- `getUserPreferences` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
- `createFamilyMember` - —Å–æ–∑–¥–∞–Ω–∏–µ —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏
- `updateFamilyMember` / `deleteFamilyMember` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–°–æ–∑–¥–∞—Ç—å —é–Ω–∏—Ç —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º:
- Happy path
- Edge cases
- Error cases
- Boundary values

#### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 2: Race conditions –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É —à–∞–≥–∞–º–∏, auto-save –º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
// app/onboarding/page.tsx:93
useEffect(() => {
  if (step > 1 && step < 6) {
    autoSave(); // –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
  }
}, [step, formData, autoSave]);
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç debounce –¥–ª—è auto-save
- ‚ö†Ô∏è –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚ö†Ô∏è –ú–æ–≥—É—Ç –±—ã—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –ë–î

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
const debouncedAutoSave = useMemo(
  () => debounce(autoSave, 1000),
  [autoSave]
);
```

#### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ optimistic locking
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –î–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚ùå Last write wins - –º–æ–≥—É—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è –¥–∞–Ω–Ω—ã–µ
- ‚ùå –ù–µ—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `version` –≤ —Ç–∞–±–ª–∏—Ü—É preferences
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å version –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ

### 5.2 –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ 4: –ù–µ–ø–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
**–ú–µ—Å—Ç–∞ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏:**
1. `getUserPreferences` - –Ω–µ—Ç retry –¥–ª—è connection errors
2. `createFamilyMember` - –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
3. `updateFamilyMember` - –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ —Å retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–º

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ 5: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
**–ü—Ä–æ–±–ª–µ–º—ã:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∑–Ω–∞–µ—Ç –æ–± –æ—à–∏–±–∫–∞—Ö —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
- –ü–ª–æ—Ö–æ–π UX

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç–µ—Ö –∂–µ —Å—Ö–µ–º
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ 6: –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
**–°—Ü–µ–Ω–∞—Ä–∏–∏:**
- –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
- –ò—Å—Ç–µ–∫—à–∞—è —Å–µ—Å—Å–∏—è –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
- –û—à–∏–±–∫–∞ –ë–î

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –î–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ localStorage –∫–∞–∫ fallback
- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö

### 5.3 –£–ª—É—á—à–µ–Ω–∏—è

#### üí° –£–ª—É—á—à–µ–Ω–∏–µ 1: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ fallback –º–µ—Ç–æ–¥–æ–≤
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É –æ—à–∏–±–æ–∫
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

#### üí° –£–ª—É—á—à–µ–Ω–∏–µ 2: –£–ª—É—á—à–∏—Ç—å UX
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º

#### üí° –£–ª—É—á—à–µ–Ω–∏–µ 3: –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏ –≤ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## 6. –ü–õ–ê–ù –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### 6.1 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### –¢–µ—Å—Ç Suite 1: saveUserPreferences
```typescript
describe("saveUserPreferences", () => {
  it("should save new interview data", () => {});
  it("should merge with existing interview data", () => {});
  it("should handle empty data", () => {});
  it("should handle partial updates", () => {});
  it("should retry on conflict errors", () => {});
  it("should retry on connection errors", () => {});
  it("should preserve existing data when updating", () => {});
  it("should handle all 32 interview fields", () => {});
});
```

#### –¢–µ—Å—Ç Suite 2: createFamilyMember
```typescript
describe("createFamilyMember", () => {
  it("should create new family member", () => {});
  it("should verify user owns preferences", () => {});
  it("should generate unique sharing token", () => {});
  it("should handle duplicate email", () => {});
  it("should handle invalid data", () => {});
  it("should create legacy shared_access record", () => {});
});
```

#### –¢–µ—Å—Ç Suite 3: getUserPreferences
```typescript
describe("getUserPreferences", () => {
  it("should return preferences for existing user", () => {});
  it("should return null for non-existent user", () => {});
  it("should handle PGRST116 error", () => {});
  it("should retry on connection errors", () => {});
  it("should return interview_data", () => {});
});
```

### 6.2 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

#### –¢–µ—Å—Ç Suite 4: End-to-End —Å–æ–∑–¥–∞–Ω–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π
```typescript
describe("E2E: Create Memories", () => {
  it("should create memories through onboarding flow", () => {});
  it("should load memories on memories page", () => {});
  it("should edit memories and save changes", () => {});
  it("should preserve data on page reload", () => {});
});
```

#### –¢–µ—Å—Ç Suite 5: End-to-End –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏
```typescript
describe("E2E: Add Family Member", () => {
  it("should add family member through UI", () => {});
  it("should send email invitation", () => {});
  it("should display member in list", () => {});
  it("should allow editing member access", () => {});
  it("should allow deleting member", () => {});
});
```

### 6.3 –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: Edge Cases

#### –¢–µ—Å—Ç Suite 6: Edge Cases
```typescript
describe("Edge Cases", () => {
  it("should handle very long answers (>5000 chars)", () => {});
  it("should handle special characters in answers", () => {});
  it("should handle empty strings vs null", () => {});
  it("should handle concurrent edits", () => {});
  it("should handle network interruptions", () => {});
});
```

---

## 7. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ –ö–û–î–ê

### 7.1 –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–∏—Ç—å debounce –¥–ª—è auto-save**
   ```typescript
   const debouncedAutoSave = useMemo(
     () => debounce(autoSave, 1000),
     [autoSave]
   );
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ**
   ```typescript
   const validateForm = () => {
     const errors = validateData(interviewSchema, formData);
     if (!errors.success) {
       setErrors(errors.errors);
       return false;
     }
     return true;
   };
   ```

3. **–î–æ–±–∞–≤–∏—Ç—å localStorage fallback**
   ```typescript
   const saveToLocalStorage = (data: Record<string, string>) => {
     localStorage.setItem('memories_draft', JSON.stringify(data));
   };
   ```

4. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫**
   ```typescript
   if (error) {
     if (isConnectionError(error)) {
       // Retry with exponential backoff
       return retryWithBackoff(() => saveUserPreferences(preferences));
     }
     // Handle other errors
   }
   ```

### 7.2 –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–∏—Ç—å optimistic locking**
   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `version` –≤ —Ç–∞–±–ª–∏—Ü—É
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å version –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

2. **–î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º**
   - Exponential backoff
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ retry –ø–æ–ø—ã—Ç–æ–∫

3. **–£–ª—É—á—à–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –ê–ª–µ—Ä—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

### 7.3 –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏**
   - Unit tests –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
   - Integration tests –¥–ª—è API routes
   - E2E tests –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

2. **–î–æ–±–∞–≤–∏—Ç—å offline support**
   - Service Worker –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
   - IndexedDB –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

3. **–£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
   - Lazy loading –¥–∞–Ω–Ω—ã—Ö
   - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

---

## 8. –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

**–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:** ‚ö†Ô∏è 30% (—Ç–æ–ª—å–∫–æ validation –∏ error-handler)
**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:** ‚úÖ –•–æ—Ä–æ—à–µ–µ (–Ω–æ —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏–π)
**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** ‚ö†Ô∏è –ë–∞–∑–æ–≤–∞—è (—Ç—Ä–µ–±—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
**Fallback –º–µ—Ç–æ–¥—ã:** ‚úÖ –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç (–Ω–æ —Ç—Ä–µ–±—É—é—Ç —É–ª—É—á—à–µ–Ω–∏—è)

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

1. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
2. ‚ùå –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ race conditions
3. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ optimistic locking
4. ‚ö†Ô∏è –ù–µ–ø–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
5. ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

**–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
1. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è `saveUserPreferences`
2. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è `createFamilyMember`
3. –î–æ–±–∞–≤–∏—Ç—å debounce –¥–ª—è auto-save
4. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

**–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
1. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Å retry
2. –î–æ–±–∞–≤–∏—Ç—å localStorage fallback
3. –î–æ–±–∞–≤–∏—Ç—å optimistic locking

**–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
2. –£–ª—É—á—à–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
3. –î–æ–±–∞–≤–∏—Ç—å offline support

---

**END OF REPORT**

–≠—Ç–æ—Ç –æ—Ç—á–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–∞, –≤–∫–ª—é—á–∞—è –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –ø–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

